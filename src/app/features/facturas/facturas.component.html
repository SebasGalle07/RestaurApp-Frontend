<section class="grid">
  <aside class="card">
    <h2>Emitir factura</h2>
    <form [formGroup]="emitirForm" (ngSubmit)="emitir()" class="form-grid">
      <label>Pedido ID <input formControlName="pedidoId" /></label>
      <button type="submit">Generar</button>
    </form>

    <h3>Filtros</h3>
    <form [formGroup]="filtrosForm" (ngSubmit)="listar()" class="form-grid">
      <label>Mesa ID <input formControlName="mesa_id" /></label>
      <label>Mesero UUID <input formControlName="mesero_id" /></label>
      <label>Desde <input type="date" formControlName="desde" /></label>
      <label>Hasta <input type="date" formControlName="hasta" /></label>
      <label>
        Ordenar
        <select formControlName="sort">
          <option value="fechaEmision,desc">Fecha desc</option>
          <option value="fechaEmision,asc">Fecha asc</option>
        </select>
      </label>
      <button type="submit">Aplicar</button>
    </form>

    <section class="facturables">
      <header class="facturables-header">
        <h3>Pedidos listos para facturar</h3>
        <button type="button" (click)="cargarFacturables()">Actualizar</button>
      </header>
      <p class="muted" *ngIf="!facturables().length">No hay pedidos listos para facturar.</p>
      <table *ngIf="facturables().length">
        <thead>
          <tr>
            <th>ID</th>
            <th>Mesa</th>
            <th>Mesero</th>
            <th>Total</th>
            <th>Saldo</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let pedido of facturables()">
            <td>{{ pedido.id }}</td>
            <td>{{ pedido.mesaNumero }}</td>
            <td>{{ pedido.meseroNombre || pedido.meseroId }}</td>
            <td>{{ pedido.total | currency:'COP':'symbol':'1.0-0' }}</td>
            <td>{{ pedido.saldoPendiente | currency:'COP':'symbol':'1.0-0' }}</td>
            <td><button type="button" (click)="seleccionarPedido(pedido)">Usar</button></td>
          </tr>
        </tbody>
      </table>
    </section>
  </aside>

  <section class="card">
    <h2>Facturas</h2>
    <p class="error" *ngIf="error()">{{ error() }}</p>
    <div class="facturas-search">
      <input [formControl]="searchControl" placeholder="Buscar por mesa, pedido o nÃºmero" />
    </div>
    <table *ngIf="facturasFiltradas().length; else noFacturas">
      <thead>
        <tr>
          <th>ID</th>
          <th>Numero</th>
          <th>Mesa</th>
          <th>Mesero</th>
          <th>Total</th>
          <th>Fecha</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let factura of facturasFiltradas()">
          <td>{{ factura.id }}</td>
          <td>{{ factura.numero }}</td>
          <td>{{ factura.mesaNumero }}</td>
          <td>{{ factura.meseroNombre || factura.meseroId }}</td>
          <td>{{ factura.total | currency:'COP':'symbol':'1.0-0' }}</td>
          <td>{{ factura.fechaEmision | date:'short' }}</td>
          <td><button (click)="verDetalle(factura.id)">Detalle</button></td>
        </tr>
      </tbody>
    </table>
    <ng-template #noFacturas>
      <p class="muted">No se encontraron facturas con los criterios actuales.</p>
    </ng-template>

    <article class="detalle" *ngIf="detalle() as fact">
      <h3>Factura #{{ fact.numero }}</h3>
      <ul>
        <li><strong>Pedido:</strong> {{ fact.pedidoId }}</li>
        <li><strong>Mesa:</strong> {{ fact.mesaNumero }} ({{ fact.mesaId }})</li>
        <li><strong>Mesero:</strong> {{ fact.meseroNombre || fact.meseroId }}</li>
        <li><strong>Total:</strong> {{ fact.total | currency:'COP':'symbol':'1.0-0' }}</li>
        <li><strong>Fecha:</strong> {{ fact.fechaEmision | date:'medium' }}</li>
      </ul>
    </article>
  </section>
</section>
